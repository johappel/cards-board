<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quill.js Plugin - Final Fix Test</title>
    
    <!-- CSS f√ºr die Hauptanwendung -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="board.css">
    <link rel="stylesheet" href="card.css">
    <link rel="stylesheet" href="modal.css">
    <link rel="stylesheet" href="sidebar.css">
    <link rel="stylesheet" href="markdown.css">
    <link rel="stylesheet" href="quilljs-plugin.css">
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-header {
            background: #2563eb;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
        
        .test-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: #059669;
        }
        
        .test-button.secondary {
            background: #6b7280;
        }
        
        .test-button.secondary:hover {
            background: #4b5563;
        }
        
        .test-output {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        .status-info { background: #3b82f6; }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        
        .log-entry.success { color: #059669; }
        .log-entry.error { color: #dc2626; }
        .log-entry.warning { color: #d97706; }
        .log-entry.info { color: #2563eb; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üîß Quill.js Plugin - Final Fix Test</h1>
            <p>Test f√ºr Content-Loading-Fix mit Data-Attributen und Markdown-Content-Wrapper</p>
        </div>
        
        <div class="test-section">
            <h3>üìã Test Board Setup</h3>
            <p>Erstelle ein Test-Board mit Sample-Daten zum Testen des Plugins</p>
            <button class="test-button" onclick="setupTestBoard()">Test Board erstellen</button>
            <button class="test-button secondary" onclick="clearTestData()">Test-Daten l√∂schen</button>
            <div class="test-output" id="setup-output"></div>
        </div>
        
        <div class="test-section">
            <h3>üîç Plugin Status Check</h3>
            <p>√úberpr√ºfe den aktuellen Status des Quill.js Plugins</p>
            <button class="test-button" onclick="checkPluginStatus()">Plugin Status pr√ºfen</button>
            <button class="test-button" onclick="togglePlugin()">Plugin Toggle</button>
            <div class="test-output" id="plugin-status-output"></div>
        </div>
        
        <div class="test-section">
            <h3>üéØ Modal & Data Attributes Test</h3>
            <p>Teste das √ñffnen des Full Card Modals und √ºberpr√ºfe data-Attribute</p>
            <button class="test-button" onclick="openTestModal()">Test Modal √∂ffnen</button>
            <button class="test-button" onclick="checkDataAttributes()">Data Attributes pr√ºfen</button>
            <button class="test-button secondary" onclick="inspectModalHTML()">Modal HTML anzeigen</button>
            <div class="test-output" id="modal-test-output"></div>
        </div>
        
        <div class="test-section">
            <h3>‚úèÔ∏è Editor Activation Test</h3>
            <p>Teste die Aktivierung des Quill.js Editors</p>
            <button class="test-button" onclick="activateEditor()">Editor aktivieren</button>
            <button class="test-button" onclick="checkEditorContent()">Editor Content pr√ºfen</button>
            <button class="test-button secondary" onclick="deactivateEditor()">Editor deaktivieren</button>
            <div class="test-output" id="editor-test-output"></div>
        </div>
        
        <div class="test-section">
            <h3>üìñ Content Loading Test</h3>
            <p>Teste ob der originale Markdown-Content korrekt im Editor geladen wird</p>
            <button class="test-button" onclick="testContentLoading()">Content Loading testen</button>
            <button class="test-button" onclick="compareContent()">Original vs Editor vergleichen</button>
            <div class="test-output" id="content-test-output"></div>
        </div>
    </div>
    
    <!-- Verstecktes Board-Container f√ºr Tests -->
    <div id="board-container" style="display: none;"></div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <!-- Basis-Scripts -->
    <script src="utils.js"></script>
    <script src="storage.js"></script>
    <script src="colors.js"></script>
    <script src="init.js"></script>
    <script src="board.js"></script>
    <script src="column.js"></script>
    <script src="card.js"></script>
    <script src="chatbot.js"></script>
    
    <!-- Plugin -->
    <script src="quilljs-plugin-manual.js"></script>
    
    <script>
        // Test-Variablen
        let testCardId = 'test-card-1';
        let testColumnId = 'test-column-1';
        let testBoardId = 'test-board-1';
        
        // Logging-Funktion
        function logToOutput(outputId, message, type = 'info') {
            const output = document.getElementById(outputId);
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = `status-${type}`;
            const logClass = `log-entry ${type}`;
            
            const logEntry = document.createElement('div');
            logEntry.className = logClass;
            logEntry.innerHTML = `<span class="status-indicator ${statusClass}"></span>[${timestamp}] ${message}`;
            
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput(outputId) {
            document.getElementById(outputId).innerHTML = '';
        }
        
        // Test Board Setup
        function setupTestBoard() {
            clearOutput('setup-output');
            logToOutput('setup-output', 'Erstelle Test-Board...', 'info');
            
            try {
                // Mock currentBoard erstellen
                window.currentBoard = {
                    id: testBoardId,
                    name: 'Test Board f√ºr Quill.js Plugin',
                    columns: [
                        {
                            id: testColumnId,
                            name: 'Test Column',
                            cards: [
                                {
                                    id: testCardId,
                                    heading: 'Test Card mit Markdown Content',
                                    content: `# Test Markdown Content

Dies ist ein **Test-Inhalt** mit verschiedenen Markdown-Elementen:

## Features
- Listen-Element 1
- Listen-Element 2
- *Kursiver Text*

## Code
\`\`\`javascript
console.log('Hello World');
\`\`\`

> Dies ist ein Blockquote

[Link zu GitHub](https://github.com)`,
                                    color: 'color-gradient-1',
                                    labels: 'Test, Quill, Plugin',
                                    comments: 'Dies ist ein Test-Kommentar',
                                    url: 'https://example.com',
                                    inactive: false
                                }
                            ]
                        }
                    ]
                };
                
                logToOutput('setup-output', 'Test-Board erfolgreich erstellt', 'success');
                logToOutput('setup-output', `Board ID: ${testBoardId}`, 'info');
                logToOutput('setup-output', `Column ID: ${testColumnId}`, 'info');
                logToOutput('setup-output', `Card ID: ${testCardId}`, 'info');
                logToOutput('setup-output', `Content Length: ${window.currentBoard.columns[0].cards[0].content.length} Zeichen`, 'info');
                
            } catch (error) {
                logToOutput('setup-output', `Fehler beim Erstellen des Test-Boards: ${error.message}`, 'error');
            }
        }
        
        function clearTestData() {
            clearOutput('setup-output');
            window.currentBoard = null;
            logToOutput('setup-output', 'Test-Daten gel√∂scht', 'success');
        }
        
        // Plugin Status Check
        function checkPluginStatus() {
            clearOutput('plugin-status-output');
            logToOutput('plugin-status-output', '√úberpr√ºfe Plugin-Status...', 'info');
            
            try {
                const pluginExists = typeof window.QuillEditorPlugin !== 'undefined';
                const isEnabled = pluginExists ? window.QuillEditorPlugin.isEnabled() : false;
                const librariesLoaded = typeof window.Quill !== 'undefined';
                
                logToOutput('plugin-status-output', `Plugin verf√ºgbar: ${pluginExists ? '‚úÖ' : '‚ùå'}`, pluginExists ? 'success' : 'error');
                logToOutput('plugin-status-output', `Plugin aktiviert: ${isEnabled ? '‚úÖ' : '‚ùå'}`, isEnabled ? 'success' : 'warning');
                logToOutput('plugin-status-output', `Quill.js geladen: ${librariesLoaded ? '‚úÖ' : '‚ùå'}`, librariesLoaded ? 'success' : 'warning');
                
                if (window.QuillDebug) {
                    const debugInfo = window.QuillDebug;
                    logToOutput('plugin-status-output', `Aktive Editoren: ${debugInfo.editors().size}`, 'info');
                    logToOutput('plugin-status-output', `Bibliotheken geladen: ${debugInfo.librariesLoaded() ? '‚úÖ' : '‚ùå'}`, 'info');
                }
                
            } catch (error) {
                logToOutput('plugin-status-output', `Fehler bei Status-Check: ${error.message}`, 'error');
            }
        }
        
        function togglePlugin() {
            try {
                if (window.QuillEditorPlugin) {
                    const newState = window.QuillEditorPlugin.toggle();
                    logToOutput('plugin-status-output', `Plugin ${newState ? 'aktiviert' : 'deaktiviert'}`, 'success');
                    checkPluginStatus();
                } else {
                    logToOutput('plugin-status-output', 'Plugin nicht verf√ºgbar', 'error');
                }
            } catch (error) {
                logToOutput('plugin-status-output', `Fehler beim Toggle: ${error.message}`, 'error');
            }
        }
        
        // Modal & Data Attributes Test
        function openTestModal() {
            clearOutput('modal-test-output');
            logToOutput('modal-test-output', '√ñffne Test-Modal...', 'info');
            
            try {
                if (!window.currentBoard) {
                    logToOutput('modal-test-output', 'Bitte zuerst Test-Board erstellen', 'error');
                    return;
                }
                
                // Modal √∂ffnen
                showCardFullModal(testCardId, testColumnId);
                
                setTimeout(() => {
                    const modal = document.getElementById('full-card-modal');
                    if (modal) {
                        logToOutput('modal-test-output', 'Modal erfolgreich ge√∂ffnet', 'success');
                        checkDataAttributes();
                    } else {
                        logToOutput('modal-test-output', 'Modal nicht gefunden', 'error');
                    }
                }, 100);
                
            } catch (error) {
                logToOutput('modal-test-output', `Fehler beim √ñffnen des Modals: ${error.message}`, 'error');
            }
        }
        
        function checkDataAttributes() {
            try {
                const modal = document.getElementById('full-card-modal');
                if (!modal) {
                    logToOutput('modal-test-output', 'Modal nicht ge√∂ffnet', 'error');
                    return;
                }
                
                const cardContentElement = modal.querySelector('.card-content-full');
                if (!cardContentElement) {
                    logToOutput('modal-test-output', '.card-content-full Element nicht gefunden', 'error');
                    return;
                }
                
                const cardId = cardContentElement.getAttribute('data-card-id');
                const columnId = cardContentElement.getAttribute('data-column-id');
                
                logToOutput('modal-test-output', `data-card-id: ${cardId || 'NICHT GESETZT'}`, cardId ? 'success' : 'error');
                logToOutput('modal-test-output', `data-column-id: ${columnId || 'NICHT GESETZT'}`, columnId ? 'success' : 'error');
                
                // Pr√ºfe auch markdown-content Container
                const markdownContent = cardContentElement.querySelector('.markdown-content');
                if (markdownContent) {
                    const mdCardId = markdownContent.getAttribute('data-card-id');
                    const mdColumnId = markdownContent.getAttribute('data-column-id');
                    
                    logToOutput('modal-test-output', `markdown-content data-card-id: ${mdCardId || 'NICHT GESETZT'}`, mdCardId ? 'success' : 'warning');
                    logToOutput('modal-test-output', `markdown-content data-column-id: ${mdColumnId || 'NICHT GESETZT'}`, mdColumnId ? 'success' : 'warning');
                } else {
                    logToOutput('modal-test-output', '.markdown-content Container nicht gefunden', 'warning');
                }
                
            } catch (error) {
                logToOutput('modal-test-output', `Fehler bei Data-Attribute Check: ${error.message}`, 'error');
            }
        }
        
        function inspectModalHTML() {
            try {
                const modal = document.getElementById('full-card-modal');
                if (!modal) {
                    logToOutput('modal-test-output', 'Modal nicht ge√∂ffnet', 'error');
                    return;
                }
                
                const cardContentElement = modal.querySelector('.card-content-full');
                if (cardContentElement) {
                    const html = cardContentElement.outerHTML;
                    logToOutput('modal-test-output', 'Modal HTML:', 'info');
                    logToOutput('modal-test-output', html.substring(0, 500) + '...', 'info');
                }
                
            } catch (error) {
                logToOutput('modal-test-output', `Fehler bei HTML-Inspektion: ${error.message}`, 'error');
            }
        }
        
        // Editor Activation Test
        function activateEditor() {
            clearOutput('editor-test-output');
            logToOutput('editor-test-output', 'Aktiviere Editor...', 'info');
            
            try {
                const modal = document.getElementById('full-card-modal');
                if (!modal) {
                    logToOutput('editor-test-output', 'Modal nicht ge√∂ffnet - bitte zuerst √∂ffnen', 'error');
                    return;
                }
                
                const cardContentElement = modal.querySelector('.card-content-full');
                if (!cardContentElement) {
                    logToOutput('editor-test-output', '.card-content-full nicht gefunden', 'error');
                    return;
                }
                
                // Plugin aktivieren falls n√∂tig
                if (!window.QuillEditorPlugin.isEnabled()) {
                    window.QuillEditorPlugin.enable();
                    logToOutput('editor-test-output', 'Plugin aktiviert', 'info');
                }
                
                // Editor f√ºr die Test-Karte aktivieren
                window.QuillEditorPlugin.activateEditor(cardContentElement, testCardId, testColumnId);
                
                setTimeout(() => {
                    logToOutput('editor-test-output', 'Editor-Aktivierung abgeschlossen', 'success');
                    checkEditorContent();
                }, 1000);
                
            } catch (error) {
                logToOutput('editor-test-output', `Fehler bei Editor-Aktivierung: ${error.message}`, 'error');
            }
        }
        
        function checkEditorContent() {
            try {
                if (window.QuillDebug) {
                    const editors = window.QuillDebug.editors();
                    const editorData = editors.get(testCardId);
                    
                    if (editorData) {
                        logToOutput('editor-test-output', 'Editor gefunden', 'success');
                        logToOutput('editor-test-output', `Original Content: ${editorData.originalContent.length} Zeichen`, 'info');
                        
                        const currentContent = editorData.quill.getSemanticHTML();
                        logToOutput('editor-test-output', `Aktueller Content: ${currentContent.length} Zeichen`, 'info');
                        logToOutput('editor-test-output', `Content Preview: ${currentContent.substring(0, 100)}...`, 'info');
                        
                        // Pr√ºfe ob Content geladen wurde
                        if (currentContent.length > 50) {
                            logToOutput('editor-test-output', 'Content erfolgreich geladen! ‚úÖ', 'success');
                        } else {
                            logToOutput('editor-test-output', 'Content m√∂glicherweise nicht geladen ‚ö†Ô∏è', 'warning');
                        }
                        
                    } else {
                        logToOutput('editor-test-output', 'Kein aktiver Editor gefunden', 'error');
                    }
                } else {
                    logToOutput('editor-test-output', 'QuillDebug nicht verf√ºgbar', 'error');
                }
                
            } catch (error) {
                logToOutput('editor-test-output', `Fehler bei Content-Check: ${error.message}`, 'error');
            }
        }
        
        function deactivateEditor() {
            try {
                window.QuillEditorPlugin.deactivateEditor(testCardId);
                logToOutput('editor-test-output', 'Editor deaktiviert', 'success');
            } catch (error) {
                logToOutput('editor-test-output', `Fehler bei Editor-Deaktivierung: ${error.message}`, 'error');
            }
        }
        
        // Content Loading Test  
        function testContentLoading() {
            clearOutput('content-test-output');
            logToOutput('content-test-output', 'Teste Content Loading...', 'info');
            
            try {
                if (!window.currentBoard) {
                    logToOutput('content-test-output', 'Bitte zuerst Test-Board erstellen', 'error');
                    return;
                }
                
                // Original Content holen
                const originalCard = window.currentBoard.columns[0].cards[0];
                const originalContent = originalCard.content;
                
                logToOutput('content-test-output', `Original Content: ${originalContent.length} Zeichen`, 'info');
                logToOutput('content-test-output', `Preview: ${originalContent.substring(0, 100)}...`, 'info');
                
                // Pr√ºfen ob Modal offen ist
                const modal = document.getElementById('full-card-modal');
                if (!modal) {
                    logToOutput('content-test-output', 'Modal nicht ge√∂ffnet', 'error');
                    return;
                }
                
                // Rendered HTML Content pr√ºfen
                const cardContentElement = modal.querySelector('.card-content-full');
                const displayedHtml = cardContentElement.innerHTML;
                
                logToOutput('content-test-output', `Angezeigter HTML: ${displayedHtml.length} Zeichen`, 'info');
                
                // Pr√ºfen ob Content korrekt gerendert wurde
                if (displayedHtml.includes('Test-Inhalt') && displayedHtml.includes('Features')) {
                    logToOutput('content-test-output', 'HTML-Rendering korrekt ‚úÖ', 'success');
                } else {
                    logToOutput('content-test-output', 'HTML-Rendering fehlerhaft ‚ùå', 'error');
                }
                
            } catch (error) {
                logToOutput('content-test-output', `Fehler bei Content Loading Test: ${error.message}`, 'error');
            }
        }
        
        function compareContent() {
            try {
                if (!window.QuillDebug) {
                    logToOutput('content-test-output', 'QuillDebug nicht verf√ºgbar', 'error');
                    return;
                }
                
                const editors = window.QuillDebug.editors();
                const editorData = editors.get(testCardId);
                
                if (!editorData) {
                    logToOutput('content-test-output', 'Kein aktiver Editor f√ºr Vergleich', 'error');
                    return;
                }
                
                const original = editorData.originalContent;
                const editorHtml = editorData.quill.getSemanticHTML();
                
                logToOutput('content-test-output', '=== CONTENT VERGLEICH ===', 'info');
                logToOutput('content-test-output', `Original (Markdown): ${original.length} Zeichen`, 'info');
                logToOutput('content-test-output', `Editor (HTML): ${editorHtml.length} Zeichen`, 'info');
                
                // Einfacher Vergleich - suche nach Key-W√∂rtern
                const keywords = ['Test-Inhalt', 'Features', 'Code', 'GitHub'];
                let matches = 0;
                
                for (const keyword of keywords) {
                    if (original.includes(keyword) && editorHtml.includes(keyword)) {
                        matches++;
                        logToOutput('content-test-output', `‚úÖ Keyword "${keyword}" gefunden in beiden`, 'success');
                    } else {
                        logToOutput('content-test-output', `‚ùå Keyword "${keyword}" fehlt`, 'error');
                    }
                }
                
                const percentage = Math.round((matches / keywords.length) * 100);
                logToOutput('content-test-output', `√úbereinstimmung: ${percentage}% (${matches}/${keywords.length})`, 
                    percentage >= 75 ? 'success' : 'warning');
                
            } catch (error) {
                logToOutput('content-test-output', `Fehler bei Content-Vergleich: ${error.message}`, 'error');
            }
        }
        
        // Auto-setup beim Laden
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                setupTestBoard();
                checkPluginStatus();
            }, 500);
        });
    </script>
</body>
</html>
