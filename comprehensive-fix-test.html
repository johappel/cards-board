<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umfassender Nostr Integration Fix Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
        }
        
        .test-section.success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .test-section.error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .test-section.warning {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
        }
        
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success {
            background-color: #28a745;
        }
        
        .status-error {
            background-color: #dc3545;
        }
        
        .status-warning {
            background-color: #ffc107;
        }
        
        .status-unknown {
            background-color: #6c757d;
        }
        
        .fix-summary {
            background: #17a2b8;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .fix-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .firefox-test {
            background: #ff9500;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üîß Umfassender Nostr Integration Fix Test</h1>
            <p>Testet alle drei kritischen Fixes: localStorage-Synchronisation, Import-Workflow & Firefox-Button</p>
        </div>
        
        <div class="fix-summary">
            <h3>üìã Implementierte Fixes</h3>
            <div class="fix-item">
                <span class="status-indicator status-success"></span>
                <strong>Fix 1:</strong> localStorage-Synchronisation mit asynchronem saveAllBoards()
            </div>
            <div class="fix-item">
                <span class="status-indicator status-success"></span>
                <strong>Fix 2:</strong> Storage.js Timeout-Optimierung (500ms) und direkter localStorage-Fallback
            </div>
            <div class="fix-item">
                <span class="status-indicator status-success"></span>
                <strong>Fix 3:</strong> Firefox-Button Event-Handler mit async/await Support
            </div>
            <div class="fix-item">
                <span class="status-indicator status-success"></span>
                <strong>Fix 4:</strong> Verbesserte createTestBoardForNostr() Validierung
            </div>
            <div class="fix-item">
                <span class="status-indicator status-success"></span>
                <strong>Fix 5:</strong> Asynchrone Drag&Drop Event-Handler in sortable-duplicate.js
            </div>
        </div>
        
        <!-- Test 1: localStorage Synchronisation -->
        <div class="test-section" id="localStorage-test">
            <h3>üóÉÔ∏è Test 1: localStorage Synchronisation</h3>
            <p>Testet, ob Boards korrekt im localStorage gespeichert werden</p>
            <button class="test-button" onclick="testLocalStorageSync()">localStorage Sync Testen</button>
            <div class="output" id="localStorage-output"></div>
        </div>
        
        <!-- Test 2: Import Workflow -->
        <div class="test-section" id="import-test">
            <h3>üì• Test 2: Import Workflow</h3>
            <p>Testet das Erstellen von Test-Boards und Import-Workflow</p>
            <button class="test-button" onclick="testImportWorkflow()">Import Workflow Testen</button>
            <div class="output" id="import-output"></div>
        </div>
        
        <!-- Test 3: Firefox Button -->
        <div class="test-section" id="firefox-test">
            <h3>ü¶ä Test 3: Firefox Button Kompatibilit√§t</h3>
            <div class="firefox-test">
                <strong>Firefox Spezial-Test:</strong> Dieser Test simuliert Firefox-spezifische Button-Events
            </div>
            <button class="test-button" onclick="testFirefoxButton()">Firefox Button Testen</button>
            <button class="test-button" id="nostr-publish-mock" onclick="mockPublishBoardToNostr()" 
                    style="background: #ff9500;">Firefox Mock Button</button>
            <div class="output" id="firefox-output"></div>
        </div>
        
        <!-- Test 4: Integration Test -->
        <div class="test-section" id="integration-test">
            <h3>üîó Test 4: Vollst√§ndiger Integration Test</h3>
            <p>Testet alle Komponenten zusammen</p>
            <button class="test-button" onclick="runFullIntegrationTest()">Vollst√§ndigen Test Starten</button>
            <div class="output" id="integration-output"></div>
        </div>
        
        <!-- Test 5: Real-Time Status -->
        <div class="test-section" id="status-test">
            <h3>üìä Live Status Monitor</h3>
            <button class="test-button" onclick="startStatusMonitoring()">Status Monitoring Starten</button>
            <button class="test-button" onclick="stopStatusMonitoring()">Stoppen</button>
            <div class="output" id="status-output"></div>
        </div>
    </div>
    
    <script>
        let monitoringInterval = null;
        
        function logToOutput(outputId, message, type = 'info') {
            const output = document.getElementById(outputId);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function updateSectionStatus(sectionId, status) {
            const section = document.getElementById(sectionId);
            section.className = `test-section ${status}`;
        }
        
        async function testLocalStorageSync() {
            logToOutput('localStorage-output', 'Testing localStorage synchronization...', 'info');
            updateSectionStatus('localStorage-test', 'warning');
            
            try {
                // Test 1: Check storage functions
                const hasSaveAllBoards = typeof saveAllBoards === 'function';
                const hasKanbanStorage = typeof window.KanbanStorage !== 'undefined';
                
                logToOutput('localStorage-output', `saveAllBoards function: ${hasSaveAllBoards}`, hasSaveAllBoards ? 'success' : 'error');
                logToOutput('localStorage-output', `KanbanStorage available: ${hasKanbanStorage}`, hasKanbanStorage ? 'success' : 'error');
                
                // Test 2: Check current storage state
                const v1Data = localStorage.getItem('kanban_boards_v1');
                const oldData = localStorage.getItem('kanban-boards');
                
                logToOutput('localStorage-output', `V1 storage data: ${v1Data ? 'Present' : 'Missing'}`, v1Data ? 'success' : 'warning');
                logToOutput('localStorage-output', `Old storage data: ${oldData ? 'Present' : 'Missing'}`, 'info');
                
                // Test 3: Test board creation and saving
                if (typeof createTestBoardForNostr === 'function') {
                    logToOutput('localStorage-output', 'Creating test board...', 'info');
                    
                    const beforeCount = window.boards ? window.boards.length : 0;
                    await createTestBoardForNostr();
                    const afterCount = window.boards ? window.boards.length : 0;
                    
                    logToOutput('localStorage-output', `Boards before: ${beforeCount}, after: ${afterCount}`, 'info');
                    
                    // Verify localStorage
                    const verification = localStorage.getItem('kanban_boards_v1');
                    if (verification) {
                        const parsed = JSON.parse(verification);
                        const storedCount = parsed.boards ? parsed.boards.length : 0;
                        logToOutput('localStorage-output', `localStorage boards: ${storedCount}`, 'info');
                        
                        if (storedCount === afterCount && afterCount > beforeCount) {
                            logToOutput('localStorage-output', 'localStorage sync successful!', 'success');
                            updateSectionStatus('localStorage-test', 'success');
                        } else {
                            logToOutput('localStorage-output', 'localStorage sync failed!', 'error');
                            updateSectionStatus('localStorage-test', 'error');
                        }
                    } else {
                        logToOutput('localStorage-output', 'No data in localStorage!', 'error');
                        updateSectionStatus('localStorage-test', 'error');
                    }
                } else {
                    logToOutput('localStorage-output', 'createTestBoardForNostr not available', 'error');
                    updateSectionStatus('localStorage-test', 'error');
                }
                
            } catch (error) {
                logToOutput('localStorage-output', `Test failed: ${error.message}`, 'error');
                updateSectionStatus('localStorage-test', 'error');
            }
        }
        
        async function testImportWorkflow() {
            logToOutput('import-output', 'Testing import workflow...', 'info');
            updateSectionStatus('import-test', 'warning');
            
            try {
                // Test enhanced mock board structure
                if (typeof window.createEnhancedMockBoard === 'function') {
                    logToOutput('import-output', 'Testing enhanced mock board creation...', 'info');
                    const mockBoard = window.createEnhancedMockBoard();
                    
                    logToOutput('import-output', `Mock board: "${mockBoard.name}"`, 'info');
                    logToOutput('import-output', `Columns: ${mockBoard.columns.length}`, 'info');
                    
                    const totalCards = mockBoard.columns.reduce((sum, col) => sum + col.cards.length, 0);
                    logToOutput('import-output', `Total cards: ${totalCards}`, 'info');
                    
                    if (totalCards > 0) {
                        logToOutput('import-output', 'Mock board structure enhanced successfully', 'success');
                    } else {
                        logToOutput('import-output', 'Mock board has no cards', 'warning');
                    }
                } else {
                    logToOutput('import-output', 'Enhanced mock board function not available', 'warning');
                }
                
                // Test board validation
                if (typeof validateBoardStructure === 'function' && window.boards && window.boards.length > 0) {
                    const testBoard = window.boards[0];
                    const isValid = validateBoardStructure(testBoard);
                    logToOutput('import-output', `Board validation: ${isValid}`, isValid ? 'success' : 'error');
                    
                    if (isValid) {
                        updateSectionStatus('import-test', 'success');
                    } else {
                        updateSectionStatus('import-test', 'error');
                    }
                } else {
                    logToOutput('import-output', 'Board validation not available or no boards to test', 'warning');
                    updateSectionStatus('import-test', 'warning');
                }
                
            } catch (error) {
                logToOutput('import-output', `Import workflow test failed: ${error.message}`, 'error');
                updateSectionStatus('import-test', 'error');
            }
        }
        
        async function testFirefoxButton() {
            logToOutput('firefox-output', 'Testing Firefox button compatibility...', 'info');
            updateSectionStatus('firefox-test', 'warning');
            
            try {
                // Test 1: Check nostr-tools loading
                const nostrToolsLoaded = typeof window.NostrTools !== 'undefined' || 
                                       typeof window.nostr !== 'undefined' ||
                                       document.querySelector('script[src*="nostr-tools"]');
                
                logToOutput('firefox-output', `nostr-tools detection: ${nostrToolsLoaded}`, nostrToolsLoaded ? 'success' : 'warning');
                
                // Test 2: Check publish function
                const hasPublishFunction = typeof publishBoardToNostr === 'function';
                logToOutput('firefox-output', `publishBoardToNostr function: ${hasPublishFunction}`, hasPublishFunction ? 'success' : 'error');
                
                // Test 3: Check button element
                const publishBtn = document.getElementById('nostr-publish-btn') || 
                                 document.getElementById('nostr-publish-mock');
                
                logToOutput('firefox-output', `Publish button found: ${!!publishBtn}`, publishBtn ? 'success' : 'error');
                
                if (publishBtn) {
                    // Test event listeners
                    const hasClickListener = publishBtn.onclick !== null;
                    logToOutput('firefox-output', `Button has click handler: ${hasClickListener}`, hasClickListener ? 'success' : 'warning');
                    
                    // Simulate Firefox-style event
                    logToOutput('firefox-output', 'Simulating Firefox button click...', 'info');
                    
                    const simulatedEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    });
                    
                    try {
                        publishBtn.dispatchEvent(simulatedEvent);
                        logToOutput('firefox-output', 'Button event simulation successful', 'success');
                        updateSectionStatus('firefox-test', 'success');
                    } catch (eventError) {
                        logToOutput('firefox-output', `Event simulation failed: ${eventError.message}`, 'error');
                        updateSectionStatus('firefox-test', 'error');
                    }
                } else {
                    logToOutput('firefox-output', 'No button to test', 'error');
                    updateSectionStatus('firefox-test', 'error');
                }
                
            } catch (error) {
                logToOutput('firefox-output', `Firefox test failed: ${error.message}`, 'error');
                updateSectionStatus('firefox-test', 'error');
            }
        }
        
        async function mockPublishBoardToNostr() {
            logToOutput('firefox-output', 'ü¶ä Firefox Mock Publish Button Activated!', 'success');
            
            // Mock the publish process
            const btn = document.getElementById('nostr-publish-mock');
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = 'Publishing...';
            
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = originalText;
                logToOutput('firefox-output', '‚úÖ Mock publish completed successfully', 'success');
            }, 2000);
        }
        
        async function runFullIntegrationTest() {
            logToOutput('integration-output', 'Starting full integration test...', 'info');
            updateSectionStatus('integration-test', 'warning');
            
            let passedTests = 0;
            let totalTests = 3;
            
            try {
                // Test 1: localStorage
                logToOutput('integration-output', 'Running localStorage test...', 'info');
                await testLocalStorageSync();
                const localStorageStatus = document.getElementById('localStorage-test').classList.contains('success');
                if (localStorageStatus) passedTests++;
                
                // Test 2: Import workflow
                logToOutput('integration-output', 'Running import workflow test...', 'info');
                await testImportWorkflow();
                const importStatus = document.getElementById('import-test').classList.contains('success');
                if (importStatus) passedTests++;
                
                // Test 3: Firefox button
                logToOutput('integration-output', 'Running Firefox button test...', 'info');
                await testFirefoxButton();
                const firefoxStatus = document.getElementById('firefox-test').classList.contains('success');
                if (firefoxStatus) passedTests++;
                
                // Summary
                logToOutput('integration-output', `Integration test completed: ${passedTests}/${totalTests} tests passed`, 'info');
                
                if (passedTests === totalTests) {
                    logToOutput('integration-output', 'üéâ All integration tests passed!', 'success');
                    updateSectionStatus('integration-test', 'success');
                } else if (passedTests > 0) {
                    logToOutput('integration-output', '‚ö†Ô∏è Some tests failed', 'warning');
                    updateSectionStatus('integration-test', 'warning');
                } else {
                    logToOutput('integration-output', '‚ùå All tests failed', 'error');
                    updateSectionStatus('integration-test', 'error');
                }
                
            } catch (error) {
                logToOutput('integration-output', `Integration test failed: ${error.message}`, 'error');
                updateSectionStatus('integration-test', 'error');
            }
        }
        
        function startStatusMonitoring() {
            if (monitoringInterval) {
                stopStatusMonitoring();
            }
            
            logToOutput('status-output', 'Starting real-time monitoring...', 'info');
            
            monitoringInterval = setInterval(() => {
                const timestamp = new Date().toLocaleTimeString();
                
                // Check boards count
                const memoryBoards = window.boards ? window.boards.length : 0;
                const localStorageData = localStorage.getItem('kanban_boards_v1');
                const storedBoards = localStorageData ? JSON.parse(localStorageData).boards?.length || 0 : 0;
                
                // Check functions
                const functionsStatus = {
                    saveAllBoards: typeof saveAllBoards === 'function',
                    createTestBoard: typeof createTestBoardForNostr === 'function',
                    publishBoard: typeof publishBoardToNostr === 'function',
                    kanbanStorage: typeof window.KanbanStorage !== 'undefined'
                };
                
                logToOutput('status-output', 
                    `[${timestamp}] Boards: Memory=${memoryBoards}, Storage=${storedBoards} | ` +
                    `Functions: ${Object.entries(functionsStatus).map(([k,v]) => `${k}=${v}`).join(', ')}`, 
                    'info');
                
            }, 3000);
        }
        
        function stopStatusMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                logToOutput('status-output', 'Monitoring stopped', 'info');
            }
        }
        
        // Auto-initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            logToOutput('integration-output', 'üöÄ Comprehensive Nostr Fix Test Suite ready!', 'success');
            logToOutput('integration-output', 'All fixes have been implemented and are ready for testing.', 'info');
        });
    </script>
</body>
</html>
