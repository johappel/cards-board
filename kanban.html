<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="column.css">
    <link rel="stylesheet" href="card.css">
    <link rel="stylesheet" href="modal.css">
    <link rel="stylesheet" href="chatbot.css">
    <link rel="stylesheet" href="board.css">
    <link rel="stylesheet" href="colors.css">
    <link rel="stylesheet" href="markdown.css">
    <link rel="stylesheet" href="duplicate.css">
    <link rel="stylesheet" href="sidebar.css">
    <link rel="stylesheet" href="share_via_nostr.css">
    <link rel="stylesheet" href="quilljs-plugin.css">
    <!-- SortableJS f√ºr Drag&Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
    <!-- Dashboard View -->
    <div id="dashboard">
        <div class="dashboard-header">
            <h1>Kanban Board Dashboard</h1>
            <div class="file-actions">
                <button class="settings-toggle" onclick="openSettingsSidebar()" title="Einstellungen">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="boards-grid" id="boards-grid">
            <!-- Board cards will be inserted here -->
        </div>
    </div>

    <!-- Board View -->
    <div id="board-view">
        <div class="board-header">
            <div class="board-header-left">
                <div class="board-title" id="board-title">Board Title</div>
                <div class="board-content-grid">
                    <div class="board-summary" id="board-summary">Board summary will appear here...</div>
                    <div class="board-authors" id="board-authors">Authors: </div>
                </div>
            </div>
            <div class="board-header-actions">
                <button class="btn btn-ai" onclick="openChatbotModal()">üí¨ Chatbot</button>
                <button class="btn btn-secondary" onclick="backToDashboard()">‚Üê Dashboard</button>
                <button class="settings-toggle" onclick="openSettingsSidebar()" title="Einstellungen">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="kanban-board" id="kanban-board">
            <!-- Columns will be inserted here -->
        </div>
    </div>

    <!-- Settings Sidebar -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSettingsSidebar()"></div>
    <div class="settings-sidebar" id="settings-sidebar">
        <div class="sidebar-header">
            <h3>‚öôÔ∏è Einstellungen</h3>
            <button class="sidebar-close" onclick="closeSettingsSidebar()">&times;</button>
        </div>
        <div class="sidebar-body">
            <!-- Board Actions Section -->
            <div class="sidebar-section" id="board-actions-section" style="display: none;">
                <h4>Board Aktionen</h4>
                
                <div class="sidebar-action" onclick="openBoardSettings()">
                    <div class="sidebar-action-icon">‚öôÔ∏è</div>
                    <div class="sidebar-action-content">
                        <div class="sidebar-action-title">Board Einstellungen</div>
                        <div class="sidebar-action-desc">Name, Farbe, AI-Konfiguration</div>
                    </div>
                </div>
                
                <div class="sidebar-action" onclick="exportBoard()">
                    <div class="sidebar-action-icon">üì•</div>
                    <div class="sidebar-action-content">
                        <div class="sidebar-action-title">Board Exportieren</div>
                        <div class="sidebar-action-desc">Als JSON-Datei herunterladen</div>
                    </div>
                </div>
                
                <div class="sidebar-action" onclick="showPasteHelp()">
                    <div class="sidebar-action-icon">üìã</div>
                    <div class="sidebar-action-content">
                        <div class="sidebar-action-title">Paste Hilfe</div>
                        <div class="sidebar-action-desc">Smart Paste Funktionen</div>
                    </div>
                </div>
                
                <div class="sidebar-action" onclick="openNostrModal()">
                    <div class="sidebar-action-icon">üåê</div>
                    <div class="sidebar-action-content">
                        <div class="sidebar-action-title">Via Nostr Teilen</div>
                        <div class="sidebar-action-desc">Board als Nostr-Event ver√∂ffentlichen</div>
                    </div>
                </div>
                
                <!-- Column Width Control -->
                <div class="sidebar-width-control">
                    <div class="width-control-header">
                        <span class="width-control-label">üìè Spaltenbreite</span>
                        <span class="width-control-value" id="sidebar-width-value">300px</span>
                    </div>
                    <input type="range" 
                           id="sidebar-column-width-slider" 
                           class="width-slider" 
                           min="220" 
                           max="600" 
                           value="300" 
                           step="10" 
                           title="Spaltenbreite einstellen">
                </div>
            </div>
            
            <!-- Global Actions Section -->
            <div class="sidebar-section">
                <h4>Globale Aktionen</h4>
                
                <div class="sidebar-action" onclick="openAISettingsModal()">
                    <div class="sidebar-action-icon">üåê</div>
                    <div class="sidebar-action-content">
                        <div class="sidebar-action-title">AI & n8n Einstellungen</div>
                        <div class="sidebar-action-desc">Globale KI-Konfiguration</div>
                    </div>
                </div>
                
                <div class="sidebar-action" onclick="exportAllBoards()">
                    <div class="sidebar-action-icon">üì§</div>
                    <div class="sidebar-action-content">
                        <div class="sidebar-action-title">Alle Boards Exportieren</div>
                        <div class="sidebar-action-desc">Kompletten Workspace exportieren</div>
                    </div>
                </div>
                
                <div class="sidebar-action" onclick="document.getElementById('import-file').click()">
                    <div class="sidebar-action-icon">üì•</div>
                    <div class="sidebar-action-content">
                        <div class="sidebar-action-title">Boards Importieren</div>
                        <div class="sidebar-action-desc">JSON-Datei importieren</div>
                    </div>
                </div>
                
                <!-- Hidden file input -->
                <input type="file" id="import-file" class="file-input" accept=".json" onchange="importBoards(event)" style="display: none;">
            </div>
            
            <!-- Plugin Settings Section -->
            <div class="sidebar-section">
                <h4>üìù WYSIWYG Editor (Quill.js)</h4>
                <div class="sidebar-setting">
                    <label class="toggle-label">
                        <input type="checkbox" id="quill-enabled-toggle" onchange="toggleQuillPlugin()">
                        <span class="toggle-slider"></span>
                        Plugin aktivieren
                    </label>
                </div>
                <div class="sidebar-setting">
                    <div class="setting-info">
                        <strong>Status:</strong> <span id="quill-status">Deaktiviert</span>
                    </div>
                </div>
                <div class="sidebar-setting">
                    <div class="setting-description">
                        Erm√∂glicht direktes WYSIWYG-Bearbeiten von Card-Content im Full-Card-Modal mit Rich-Text-Formatierung.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Modal -->
    <div class="modal" id="card-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Create New Card</h2>
                <div class="modal-header-actions">
                    <button class="btn-icon paste-btn" id="smart-paste-btn" onclick="openSmartPasteModal()" title="Smart Paste - Einf√ºgen mit Vorschau">üìã</button>
                    <button class="close-btn" onclick="closeModal('card-modal')">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <form id="card-form">
                    <div class="form-group">
                        <label class="color-palette-label">Card Color</label>
                        <div class="color-palette" id="card-color-palette">
                            <div class="color-option color-gradient-1" data-color="color-gradient-1"></div>
                            <div class="color-option color-gradient-2" data-color="color-gradient-2"></div>
                            <div class="color-option color-gradient-3" data-color="color-gradient-3"></div>
                            <div class="color-option color-gradient-4" data-color="color-gradient-4"></div>
                            <div class="color-option color-gradient-5" data-color="color-gradient-5"></div>
                            <div class="color-option color-gradient-6" data-color="color-gradient-6"></div>
                            <div class="color-option color-gradient-7" data-color="color-gradient-7"></div>
                            <div class="color-option color-gradient-8" data-color="color-gradient-8"></div>
                        </div>
                        <input type="hidden" id="card-color" value="color-gradient-1">
                    </div>
                    <div class="form-group">
                        <label for="card-heading">Card Heading</label>
                        <input type="text" id="card-heading" required>
                    </div>
                    <div class="form-group relative">
                        <label for="card-content">Content</label>
                        <div class="ai-icon-container">
                            <button type="button" class="ai-icon-btn" id="open-ai-modal" title="AI Content Generator" tabindex="0">ü§ñ</button>
                        </div>
                        <textarea id="card-content" placeholder="Enter content or use as prompt..."></textarea>
                        <div class="paste-hint">
                            üí° Tipp: Sie k√∂nnen Inhalte direkt hier einf√ºgen (Strg+V) - unterst√ºtzt Text, HTML, Bilder und Links!
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="card-column">Column</label>
                        <select id="card-column">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="card-thumbnail">Thumbnail URL</label>
                        <input type="url" id="card-thumbnail" placeholder="https://example.com/thumb.jpg">
                    </div>
                    <div class="form-group">
                        <label for="card-comments">Comments</label>
                        <textarea id="card-comments" rows="2" placeholder="Zus√§tzliche Kommentare zur Karte..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="card-url">URL</label>
                        <input type="url" id="card-url" placeholder="https://example.com/related-link">
                    </div>
                    <div class="form-group">
                        <label for="card-labels">Labels</label>
                        <input type="text" id="card-labels" placeholder="Label1, Label2, Label3" title="Komma-getrennte Liste von Labels">
                        <small style="color: #666; font-size: 0.8rem; margin-top: 0.25rem; display: block;">üí° Mehrere Labels mit Komma trennen</small>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Save Card</button>
                        <button type="button" class="btn btn-danger" id="delete-card-btn" onclick="deleteCurrentCard()">Delete Card</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('card-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- AI Prompt Modal -->
    <div class="modal" id="ai-prompt-modal">
        <div class="modal-content max-420">
            <div class="modal-header">
                <h3>AI Prompt</h3>
                <button class="close-btn" onclick="closeAIPromptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="ai-prompt-input">Prompt</label>
                    <textarea id="ai-prompt-input" placeholder="Stelle eine Frage oder gib einen Befehl an die KI..."></textarea>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="ai-include-column-context"> Spalte als Kontext einbeziehen</label>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="submitAIPrompt()">Absenden</button>
                    <button class="btn btn-secondary" onclick="closeAIPromptModal()">Abbrechen</button>
                </div>    
            </div>
        </div>
    </div>

    <!-- Column Settings Modal -->
    <div class="modal" id="column-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Column Settings</h2>
                <button class="close-btn" onclick="closeModal('column-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="column-form">
                    <div class="form-group">
                        <label for="column-name">Column Name</label>
                        <input type="text" id="column-name" required>
                    </div>
                    <div class="form-group">
                        <label class="color-palette-label">Column Color</label>
                        <div class="color-palette" id="column-color-palette">
                            <div class="color-option color-gradient-1" data-color="color-gradient-1"></div>
                            <div class="color-option color-gradient-2" data-color="color-gradient-2"></div>
                            <div class="color-option color-gradient-3" data-color="color-gradient-3"></div>
                            <div class="color-option color-gradient-4" data-color="color-gradient-4"></div>
                            <div class="color-option color-gradient-5" data-color="color-gradient-5"></div>
                            <div class="color-option color-gradient-6" data-color="color-gradient-6"></div>
                            <div class="color-option color-gradient-7" data-color="color-gradient-7"></div>
                            <div class="color-option color-gradient-8" data-color="color-gradient-8"></div>
                        </div>
                        <input type="hidden" id="column-color" value="color-gradient-1">
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Save Column</button>
                        <button type="button" class="btn btn-secondary" onclick="exportColumn(currentColumn.id)">Export Column</button>
                        <button type="button" class="btn btn-secondary" onclick="importColumnData(currentColumn.id)">Import Cards</button>
                        <button type="button" class="btn btn-danger" onclick="deleteColumn(currentColumn.id)">Delete Column</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('column-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Board Settings Modal -->
    <div class="modal" id="board-settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Board Settings</h2>
                <button class="close-btn" onclick="closeModal('board-settings-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="board-settings-form">
                    <!-- Tab Navigation -->
                    <div class="tab-navigation">
                        <button type="button" class="tab-button active" onclick="switchBoardTab('general')">Allgemein</button>
                        <button type="button" class="tab-button" onclick="switchBoardTab('advanced')">Erweiterte Einstellungen</button>
                    </div>

                    <!-- General Tab -->
                    <div id="board-tab-general" class="tab-content active">
                        <div class="form-group">
                            <label for="board-name">Board Name</label>
                            <input type="text" id="board-name" required>
                        </div>
                        <div class="form-group">
                            <label for="board-authors-input">Authors (comma-separated)</label>
                            <input type="text" id="board-authors-input" placeholder="John Doe, Jane Smith">
                        </div>
                        <div class="form-group">
                            <label for="board-summary-input">Board Summary</label>
                            <textarea id="board-summary-input"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Board Background Color</label>
                            <div class="board-color-section">
                                <div class="board-color-palette" id="board-color-palette">
                                    <!-- Color options will be populated by JavaScript -->
                                </div>
                                <div class="transparency-control">
                                    <div class="transparency-header">
                                        <span></span>
                                        <span class="transparency-value" id="transparency-value">80%</span>
                                    </div>
                                    <label for="transparency-slider" class="transparency-label">Header Transparency:</label>
                                    <input type="range" 
                                           id="transparency-slider" 
                                           class="transparency-slider" 
                                           min="0" 
                                           max="100" 
                                           value="80" 
                                           step="5">
                                </div>
                                <div class="color-preview">
                                    <div class="color-preview-sample" id="color-preview-sample"></div>
                                    <div id="color-preview-text">Vorschau: rgba(245, 247, 250, 0.8)</div>
                                </div>
                            </div>
                            <!-- Hidden fields for compatibility -->
                            <input type="hidden" id="board-bg-color" value="#f5f7fa">
                            <input type="hidden" id="board-transparency" value="80">
                        </div>
                        <div class="ai-section">
                            <h3>AI Configuration</h3>
                            <div class="form-group">
                                <label for="ai-provider">LLM Provider</label>
                                <select id="ai-provider" onchange="toggleAIFields()">
                                    <option value="">Select Provider</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="form-group" id="ai-base-url-group" class="hide">
                                <label for="ai-base-url">Base URL</label>
                                <input type="url" id="ai-base-url" placeholder="https://api.example.com">
                            </div>
                            <div class="form-group">
                                <label for="ai-api-key">API Key</label>
                                <input type="password" id="ai-api-key" placeholder="Enter your API key">
                            </div>
                            <div class="form-group">
                                <label for="ai-model">Model</label>
                                <input type="text" id="ai-model" placeholder="e.g., claude-3-sonnet-20240229">
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Tab -->
                    <div id="board-tab-advanced" class="tab-content">
                        <div class="form-group">
                            <label for="board-custom-style">Custom CSS Style</label>
                            <textarea id="board-custom-style" class="custom-style-editor" placeholder="Enter custom CSS for this board...&#10;&#10;Beispiel:&#10;.kanban-board {&#10;  background: linear-gradient(45deg, #f0f0f0, #ffffff);&#10;}&#10;&#10;.kanban-column {&#10;  border-radius: 15px;&#10;}"></textarea>
                        </div>
                        <div class="form-group">
                            <label>CSS Preview</label>
                            <div class="css-preview-info">
                                <p>Das Custom CSS wird auf das gesamte Board angewendet. Verwenden Sie CSS-Selektoren wie:</p>
                                <ul>
                                    <li><code>.kanban-board</code> - Das gesamte Board</li>
                                    <li><code>.kanban-column</code> - Alle Spalten</li>
                                    <li><code>.kanban-card</code> - Alle Karten</li>
                                    <li><code>.board-header</code> - Der Board-Header</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                        <button type="button" class="btn btn-danger" onclick="deleteBoard()">Delete Board</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('board-settings-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- New Board Modal -->
    <div class="modal" id="new-board-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Board</h2>
                <button class="close-btn" onclick="closeModal('new-board-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="new-board-form">
                    <div class="form-group">
                        <label for="new-board-name">Board Name</label>
                        <input type="text" id="new-board-name" required>
                    </div>
                    <div class="form-group">
                        <label for="new-board-description">Description</label>
                        <textarea id="new-board-description"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Create Board</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('new-board-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Column Import Modal -->
    <div class="modal" id="column-import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Column Data</h2>
                <button class="close-btn" onclick="closeModal('column-import-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="column-import-file">Select JSON file</label>
                    <input type="file" id="column-import-file" accept=".json" onchange="handleColumnImport(event)">
                </div>
                <div id="column-import-preview" class="hide">
                    <h3>Preview</h3>
                    <div id="import-preview-content"></div>
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="confirmColumnImport()">Import</button>
                        <button class="btn btn-secondary" onclick="closeModal('column-import-modal')">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Modal f√ºr Card Content -->
    <div id="ai-modal" class="modal hide">
        <div class="modal-content max-420">
            <span class="close" id="ai-modal-close">&times;</span>
            <h3>AI Content Generator</h3>
            <div class="form-group">
                <label for="ai-prompt">Prompt</label>
                <textarea id="ai-prompt" rows="3" placeholder="Beschreibe, was generiert werden soll..."></textarea>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="ai-use-column-context"> Spalte als Kontext verwenden</label>
            </div>
            <div class="form-group">
                <button id="ai-submit-btn" class="btn-primary">Absenden</button>
            </div>
        </div>
    </div>

    <!-- Chatbot Modal -->
    <div id="chatbot-modal" class="modal">
        <div class="modal-content chatbot-modal-content">
            <div class="modal-header">
                <h2>Chatbot</h2>
                <button class="btn btn-secondary" id="newChatBtn" title="Neuen Chat starten (neue Connection-ID)">üÜï Neuer Chat</button>
                <button class="close-btn" onclick="closeModal('chatbot-modal')">&times;</button>
            </div>
            <div id="chatbox" class="chatbox"></div>
            <div id="chatbot-suggestions" class="chatbot-suggestions"></div>
            <div class="chatbot-input-row">
                <input id="userInput" type="text" placeholder="Nachricht eingeben...">
                <button id="sendButton" class="btn btn-primary">Senden</button>
                <span id="progressIndicator" class="hide">
                    <div class="bouncing-dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </span>
            </div>
            <div class="chatbot-statusbar-container">
                <div id="connectionStatus"></div>
            </div>
        </div>
    </div>

    <!-- AI Settings Modal (global) -->
    <div class="modal" id="ai-settings-modal">
      <div class="modal-content max-420">
        <div class="modal-header">
          <h3>Globale AI &amp; n8n Einstellungen</h3>
          <button class="close-btn" onclick="closeModal('ai-settings-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <form id="ai-settings-form">
            <div class="form-group">
              <label for="ai-websocket-url">WebSocket Endpoint</label>
              <input type="url" id="ai-websocket-url" required placeholder="wss://exaample.com/chat-websocket-endpoint">
            </div>
            <div class="form-group">
              <label for="ai-webhook-url">n8n Webhook Endpoint</label>
              <input type="url" id="ai-webhook-url" required placeholder="https://n8n.io/webhook/chat-endpoint">
            </div>
            <div class="form-group">
              <label for="ai-provider">LLM Provider</label>
              <select id="ai-provider">
                <option value="">(kein)</option>
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ai-api-key">API Key</label>
              <input type="password" id="ai-api-key" placeholder="API Key">
            </div>
            <div class="form-group">
              <label for="ai-model">Model</label>
              <input type="text" id="ai-model" placeholder="z.B. gpt-4, claude-3-sonnet-20240229">
            </div>
            <div class="form-group">
              <label for="ai-base-url">Base URL</label>
              <input type="url" id="ai-base-url" placeholder="https://api.example.com">
            </div>
            <div class="modal-actions">
              <button type="submit" class="btn btn-primary">Speichern</button>
              <button type="button" class="btn btn-secondary" onclick="closeModal('ai-settings-modal')">Abbrechen</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Smart Paste Modal -->
    <div class="modal" id="smart-paste-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Smart Paste</h2>
                <button class="close-btn" onclick="closeModal('smart-paste-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="smart-paste-section">
                    <div class="paste-instructions">
                        <h3>üìã Inhalt einf√ºgen</h3>
                        <p>F√ºgen Sie Ihren Inhalt hier ein (Strg+V). Unterst√ºtzt werden:</p>
                        <ul>
                            <li>üîó URLs (werden als Links mit Vorschau eingef√ºgt)</li>
                            <li>üñºÔ∏è Bilder (Screenshots, Dateien)</li>
                            <li>üìÑ HTML-Inhalte (werden zu Markdown konvertiert)</li>
                            <li>üìù Einfacher Text und Markdown</li>
                        </ul>
                    </div>
                    
                    <div class="paste-input-area">
                        <textarea id="smart-paste-input" 
                                  placeholder="Klicken Sie hier und dr√ºcken Sie Strg+V zum Einf√ºgen..."
                                  rows="5"></textarea>
                        <div class="paste-buttons">
                            <button class="btn btn-secondary" id="manual-paste-btn" onclick="triggerManualPaste()">üìã Aus Zwischenablage einf√ºgen</button>
                        </div>
                    </div>
                    
                    <div id="paste-preview-area" class="paste-preview-area" style="display: none;">
                        <h4>üëÄ Vorschau</h4>
                        <div id="paste-preview-content" class="paste-preview-content"></div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" id="apply-smart-paste-btn" onclick="applySmartPaste()" disabled>‚úÖ Einf√ºgen</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('smart-paste-modal')">Abbrechen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nostr Modal -->
    <div class="modal" id="nostr-modal">
        <div class="modal-content nostr-modal">
            <div class="modal-header">
                <h2>üåê Via Nostr Teilen</h2>
                <button class="close-btn" onclick="closeModal('nostr-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="nostr-message" class="nostr-message"></div>
                
                <!-- Nostr Keys Section -->
                <div class="nostr-section">
                    <h3>Nostr Schl√ºssel</h3>
                    
                    <!-- Key Format Toggle -->
                    <div class="nostr-key-format-controls">
                        <button type="button" class="nostr-btn small" onclick="toggleKeyDisplayFormat()" title="Zwischen HEX und bech32 Format wechseln">
                            üîÑ Format wechseln
                        </button>
                        <span class="nostr-format-hint">HEX ‚áÑ bech32 (nsec/npub)</span>
                    </div>
                    
                    <div class="nostr-form-group">
                        <label for="nostr-private-key">Privater Schl√ºssel</label>
                        <div class="nostr-key-input-group">
                            <input type="password" id="nostr-private-key" class="nostr-input nostr-key-input" 
                                   placeholder="64 hexadecimale Zeichen...">
                            <button type="button" class="nostr-key-toggle" onclick="togglePrivateKeyVisibility()" title="Sichtbarkeit umschalten">üëÅÔ∏è</button>
                            <button type="button" class="nostr-copy-btn" onclick="copyPrivateKey()" title="Kopieren">üìã</button>
                        </div>
                        <div class="nostr-help-text">
                            Privater Schl√ºssel zum Signieren von Events. Wird nur lokal verwendet.
                        </div>
                        <div class="nostr-warning">
                            Privaten Schl√ºssel sichern! Er kann nicht wiederhergestellt werden.
                        </div>
                    </div>
                    
                    <div class="nostr-form-group">
                        <label for="nostr-public-key">√ñffentlicher Schl√ºssel</label>
                        <div class="nostr-key-input-group">
                            <input type="text" id="nostr-public-key" class="nostr-input nostr-key-input" 
                                   placeholder="64 hexadecimale Zeichen..." readonly>
                            <button type="button" class="nostr-copy-btn" onclick="copyPublicKey()" title="Kopieren">üìã</button>
                        </div>
                        <div class="nostr-help-text">
                            √ñffentlicher Schl√ºssel
                        </div>
                    </div>
                    
                    <div class="nostr-key-actions">
                        <button type="button" class="nostr-btn" onclick="generateNostrKeys()">
                            üîë Neue Schl√ºssel Generieren
                        </button>
                    </div>
                    
                    <div class="nostr-checkbox-group">
                        <input type="checkbox" id="remember-nostr-credentials" class="nostr-checkbox">
                        <label for="remember-nostr-credentials" class="nostr-checkbox-label">
                            Schl√ºssel im Browser speichern
                        </label>
                    </div>
                </div>
                
                <!-- Relay Servers Section -->
                <div class="nostr-section relays">
                    <h3>Relay Server</h3>
                    <div class="nostr-form-group">
                        <label for="nostr-relays">Relay URLs (eine pro Zeile)</label>
                        <textarea id="nostr-relays" class="nostr-input nostr-textarea" 
                                  placeholder="wss://relay.damus.io&#10;wss://relay.nostr.band&#10;wss://nos.lol"></textarea>
                        <div class="nostr-relay-defaults">
                            Standard-Relays werden automatisch geladen, wenn keine gespeichert sind.
                        </div>
                    </div>
                </div>
                
                <!-- Publish Section -->
                <div class="nostr-section publish">
                    <h3>Auf Nostr Relays teilen</h3>
                    
                    <div class="nostr-publish-options">
                        <div class="nostr-publish-option">
                            <input type="radio" id="nostr-publish-live" name="nostr-publish-type" value="live" checked>
                            <label for="nostr-publish-live">Als ver√∂ffentlichtes Board (Kind 30023)</label>
                        </div>
                        <div class="nostr-publish-option">
                            <input type="radio" id="nostr-publish-as-draft" name="nostr-publish-type" value="draft">
                            <label for="nostr-publish-as-draft">Als Entwurf (Kind 30024)</label>
                        </div>
                    </div>
                    
                    <button type="button" class="nostr-btn primary" 
                            id="nostr-publish-btn" 
                            aria-label="Board √ºber Nostr ver√∂ffentlichen">
                        üì§ Jetzt ver√∂ffentlichen
                    </button>
                    
                    <!-- Success Section -->
                    <div id="nostr-publish-success" class="nostr-publish-success" style="display: none;">
                        <div class="nostr-success-title">Board erfolgreich geteilt!</div>
                        <p>Dieses Board wurde als Nostr-Event ver√∂ffentlicht. Verwende den Link unten zum Teilen:</p>
                        
                        <div class="nostr-link-group">
                            <input type="text" id="nostr-event-link" class="nostr-input nostr-link-input" readonly>
                            <button type="button" class="nostr-copy-btn" onclick="copyNostrLink()">
                                üìã Kopieren
                            </button>
                        </div>
                        
                        <div class="nostr-help-text">
                            Andere k√∂nnen dieses Board importieren, indem sie diesen Link in der Browser-Adresszeile √∂ffnen.
                        </div>
                    </div>
                </div>
                
                <!-- Published Boards History Section -->
                <div class="nostr-section history">
                    <h3>üìö √ñffentliche Boards</h3>
                    <div class="nostr-published-boards" id="nostr-published-boards">
                        <div class="nostr-no-history" id="nostr-no-history">
                            <p>Noch keine Boards ver√∂ffentlicht.</p>
                            <p>Ver√∂ffentlichte Board-Links werden hier f√ºr einfachen Zugriff gespeichert.</p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('nostr-modal')">Schlie√üen</button>
                </div>
            </div>
        </div>
    </div>

    <script src="storage.js"></script>
    <script src="board.js"></script>
    <script src="dashboard.js"></script>
    <script src="column.js"></script>
    <script src="card.js"></script>
    <script src="ai.js"></script>
    <script src="board_settings.js"></script>
    <script src="import_export.js"></script>
    <script src="drag_drop.js"></script>
    <script src="onpaste.js"></script>
    <script src="onpaste-url-plugin.js"></script>
    <script src="import-fix-test.js"></script>
    <!-- nostr-tools - the standard Nostr library for JS -->
    <script type="module">
        // Import nostr-tools functions from multiple CDN sources as fallback
        let nostrToolsLoaded = false;
        
        async function loadNostrTools() {
            const cdnSources = [
                'https://esm.sh/nostr-tools@1.17.0',
                'https://unpkg.com/nostr-tools@1.17.0/lib/esm/index.js'
            ];
            
            for (const source of cdnSources) {
                try {
                    console.log(`üîÑ Trying to load nostr-tools from: ${source}`);
                    const nostrModule = await import(source);
                    
                    // Make nostr-tools available globally with correct API
                    window.nostrTools = {
                        generatePrivateKey: nostrModule.generatePrivateKey,
                        getPublicKey: nostrModule.getPublicKey,
                        nip19: nostrModule.nip19,
                        finalizeEvent: nostrModule.finalizeEvent || nostrModule.finishEvent,
                        verifySignature: nostrModule.verifySignature,
                        getEventHash: nostrModule.getEventHash,
                        // Additional methods that might be needed
                        signEvent: nostrModule.signEvent,
                        validateEvent: nostrModule.validateEvent,
                        // Raw module for debugging
                        _module: nostrModule
                    };
                    
                    // Signal that crypto is ready
                    window.cryptoReady = true;
                    nostrToolsLoaded = true;
                    console.log(`‚úÖ nostr-tools loaded successfully from: ${source}`);
                    console.log('üìã Available functions:', Object.keys(nostrModule));
                    
                    // Test key generation to verify everything works
                    try {
                        const testPriv = nostrModule.generatePrivateKey();
                        const testPub = nostrModule.getPublicKey(testPriv);
                        
                        console.log('üîë nostr-tools crypto test passed:', {
                            privKeyLength: testPriv.length,
                            pubKeyLength: testPub.length,
                            finalizeEvent: typeof window.nostrTools.finalizeEvent,
                            signEvent: typeof window.nostrTools.signEvent
                        });
                    } catch (error) {
                        console.error('‚ùå nostr-tools crypto test failed:', error);
                    }
                    
                    return; // Success, exit the loop
                    
                } catch (error) {
                    console.warn(`‚ùå Failed to load from ${source}:`, error.message);
                    continue; // Try next source
                }
            }
            
            // If all sources failed, use fallback
            if (!nostrToolsLoaded) {
                console.warn('‚ö†Ô∏è All nostr-tools CDN sources failed, using fallback implementation');
                window.nostrTools = createFallbackNostrTools();
                window.cryptoReady = true;
            }
        }
        
        // Fallback implementation for basic functionality
        function createFallbackNostrTools() {
            return {
                generatePrivateKey: () => {
                    const array = new Uint8Array(32);
                    crypto.getRandomValues(array);
                    return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
                },
                getPublicKey: async (privKey) => {
                    // Simplified public key derivation
                    const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(privKey + 'pubkey'));
                    return Array.from(new Uint8Array(hash))
                        .map(b => b.toString(16).padStart(2, '0')).join('');
                },
                finalizeEvent: async (event, privKey) => {
                    // Simplified event finalization
                    const eventString = JSON.stringify([0, event.pubkey, event.created_at, event.kind, event.tags, event.content]);
                    const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(eventString));
                    const id = Array.from(new Uint8Array(hash))
                        .map(b => b.toString(16).padStart(2, '0')).join('');
                    const sig = Array.from(crypto.getRandomValues(new Uint8Array(64)))
                        .map(b => b.toString(16).padStart(2, '0')).join('');
                    return { ...event, id, sig };
                },
                verifySignature: () => true, // Fallback always returns true
                nip19: {
                    nsecEncode: (hex) => 'nsec1' + hex.substring(0, 50),
                    npubEncode: (hex) => 'npub1' + hex.substring(0, 50)
                }
            };
        }
        
        // Load nostr-tools
        loadNostrTools();
    </script>
    <script src="share_via_nostr.js"></script>
    
    <script src="nostr-test.js"></script>
    <script src="test-publishing.js"></script>
    <script src="test-board-rendering.js"></script>
    <script src="import-debug.js"></script>
    <script src="nevent-debug.js"></script>
    <script src="nevent-fix.js"></script>
    <script src="improved-import-workflow.js"></script>
    <script src="master-nostr-test.js"></script>
    <script src="nostr-test-cleanup.js"></script>
   
    <script src="init.js"></script>
    <script src="api.js"></script>
    <script src="colors.js"></script>
    <script src="utils.js"></script>
    <script src="chatbot.js"></script>
    <script src="duplicate.js"></script>
    <script src="sortable-duplicate.js"></script>
    <script src="sidebar.js"></script>
    <script src="board-colors.js"></script>
    <script>
        // Initialize column width changer
        document.addEventListener('DOMContentLoaded', function() {
            column_width_changer();
        });
        
        // Test-Funktion um verf√ºgbare Funktionen zu pr√ºfen
        window.checkNostrFunctions = function() {
            console.log('üîç Checking available Nostr functions:');
            const funcs = [
                'openNostrModal',
                'generateNostrKeys', 
                'publishBoardToNostr',
                'debugNostrState',
                'testNostrConnection',
                'createTestBoardForNostr'
            ];
            
            funcs.forEach(funcName => {
                console.log(`  ${funcName}: ${typeof window[funcName] === 'function' ? '‚úÖ' : '‚ùå'}`);
            });
            
            console.log('  window.nostrTools:', window.nostrTools ? '‚úÖ' : '‚ùå');
            console.log('  window.cryptoReady:', window.cryptoReady ? '‚úÖ' : '‚ùå');
        };
        
        // Automatischer Check nach 3 Sekunden (DEAKTIVIERT um kontinuierliche Board-Erstellung zu stoppen)
        setTimeout(() => {
            console.log('üß™ Auto-checking Nostr functions...');
            window.checkNostrFunctions();
            
            // AUTOMATISCHE TESTS DEAKTIVIERT - k√∂nnen manuell ausgef√ºhrt werden
            console.log('‚ö° Automatic tests disabled. Run manually:');
            console.log('  - quickNostrTest()');
            console.log('  - runCompleteNostrTest()');
            console.log('  - testPublishImportWorkflow()');
            
        }, 3000);
        
        // Paste-Funktionalit√§t initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initPasteFunctionality === 'function') {
                initPasteFunctionality();
                console.log('üéØ Paste functionality initialized from kanban.html');
            } else {
                console.warn('‚ùå initPasteFunctionality function not found');
            }
            
            // URL Preview Plugin initialisieren
            if (typeof URLPreviewPlugin !== 'undefined' && URLPreviewPlugin.init) {
                URLPreviewPlugin.init();
                console.log('üîó URL Preview Plugin initialized from kanban.html');
            } else {
                console.warn('‚ùå URLPreviewPlugin not found');
            }
            
            // YouTube Test-Funktion f√ºr Debugging
            window.testYouTubePreview = function() {
                console.log("üé• Testing YouTube URL Preview...");
                
                const testUrl = "https://www.youtube.com/watch?v=dQw4w9WgXcQ";
                const testPreview = {
                    title: "Rick Astley - Never Gonna Give You Up (Official Video)",
                    description: "The official video for Rick Astley's 'Never Gonna Give You Up'",
                    image: "https://img.youtube.com/vi/dQw4w9WgXcQ/maxresdefault.jpg",
                    url: testUrl,
                    isYouTube: true,
                    videoId: "dQw4w9WgXcQ",
                    embedUrl: "https://www.youtube.com/embed/dQw4w9WgXcQ",
                    authorName: "Rick Astley"
                };
                
                const testTarget = {
                    type: 'column',
                    columnId: 'col-1748536608900-to-do'
                };
                
                // Test YouTube functions
                if (typeof isYouTubeUrl !== 'undefined') {
                    console.log("‚úÖ YouTube detection:", isYouTubeUrl(testUrl));
                }
                if (typeof extractYouTubeVideoId !== 'undefined') {
                    console.log("‚úÖ Video ID:", extractYouTubeVideoId(testUrl));
                }
                if (typeof showUrlPreviewModal !== 'undefined') {
                    console.log("‚úÖ Showing YouTube preview modal...");
                    showUrlPreviewModal(testPreview, testTarget);
                } else {
                    console.log("‚ùå showUrlPreviewModal not found");
                }
            };
            
            // Auto-test nach 2 Sekunden
            setTimeout(() => {
                if (window.location.search.includes('test-youtube')) {
                    window.testYouTubePreview();
                }
            }, 2000);
        });
    </script>
    
    <!-- Nostr Publishing Test Script -->
    <script src="test-publishing.js"></script>
    
    <!-- Quill.js WYSIWYG Editor Plugin -->
    <script src="quilljs-plugin-manual.js"></script>
   
</script>
</html>