<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Manuelle Schl√ºsseleingabe</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .format-display {
            margin-top: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîë Test: Manuelle Schl√ºsseleingabe</h1>
    
    <div class="test-container">
        <h2>üìù Testszenarien</h2>
        <div class="info test-result">
            <strong>Zu testende Funktionalit√§t:</strong><br>
            1. HEX Private Key eingeben ‚Üí Automatische Generierung von Public Key<br>
            2. bech32 nsec eingeben ‚Üí Automatische Generierung von npub<br>
            3. Format-Umschaltung zwischen HEX und bech32<br>
            4. Automatisches Speichern wenn "Remember" aktiviert ist
        </div>
    </div>
    
    <div class="test-container">
        <h3>üîß Test Eingabefelder</h3>
        
        <div class="input-group">
            <label for="test-private-key">Private Key (nsec oder HEX):</label>
            <input type="text" id="test-private-key" placeholder="Geben Sie einen privaten Schl√ºssel ein...">
            <div class="format-display" id="private-key-formats"></div>
        </div>
        
        <div class="input-group">
            <label for="test-public-key">Public Key (automatisch generiert):</label>
            <input type="text" id="test-public-key" readonly placeholder="Wird automatisch ausgef√ºllt...">
            <div class="format-display" id="public-key-formats"></div>
        </div>
        
        <div class="input-group">
            <label>
                <input type="checkbox" id="test-remember"> 
                Remember Keys (f√ºr Auto-Save Test)
            </label>
        </div>
        
        <button onclick="toggleFormat()">üîÑ Format umschalten</button>
        <button onclick="clearFields()">üóëÔ∏è Felder leeren</button>
        <button onclick="runTests()">‚ñ∂Ô∏è Auto-Tests ausf√ºhren</button>
    </div>
    
    <div class="test-container">
        <h3>üìä Test Ergebnisse</h3>
        <div id="test-results"></div>
    </div>
    
    <div class="test-container">
        <h3>üîç Debug Information</h3>
        <div id="debug-info"></div>
    </div>

    <!-- Lade nostr-tools -->
    <script src="https://unpkg.com/nostr-tools@1.14.2/lib/nostr.bundle.js"></script>
    
    <script>
        let nostrToolsReady = false;
        
        // Warte auf nostr-tools
        function waitForNostrTools() {
            return new Promise((resolve) => {
                if (window.NostrTools || window.nostrTools) {
                    window.nostrTools = window.NostrTools || window.nostrTools;
                    nostrToolsReady = true;
                    resolve();
                } else {
                    setTimeout(() => waitForNostrTools().then(resolve), 100);
                }
            });
        }
        
        // Simuliere die enhanced input handler Funktionalit√§t
        async function handlePrivateKeyInput(inputValue) {
            const results = {
                input: inputValue,
                inputFormat: 'unknown',
                privateKeyHex: null,
                publicKeyHex: null,
                nsecBech32: null,
                npubBech32: null,
                error: null
            };
            
            try {
                if (!inputValue.trim()) {
                    return results;
                }
                
                await waitForNostrTools();
                
                // Detect and handle input format
                if (inputValue.startsWith('nsec1')) {
                    results.inputFormat = 'bech32';
                    try {
                        const decoded = window.nostrTools.nip19.decode(inputValue);
                        if (decoded.type === 'nsec') {
                            results.privateKeyHex = decoded.data;
                        }
                    } catch (e) {
                        results.error = 'Invalid nsec format: ' + e.message;
                        return results;
                    }
                } else if (inputValue.length === 64 && /^[0-9a-fA-F]+$/i.test(inputValue)) {
                    results.inputFormat = 'hex';
                    results.privateKeyHex = inputValue;
                } else {
                    results.error = 'Invalid key format';
                    return results;
                }
                
                if (results.privateKeyHex) {
                    // Generate public key
                    results.publicKeyHex = window.nostrTools.getPublicKey(results.privateKeyHex);
                    
                    // Generate bech32 formats
                    results.nsecBech32 = window.nostrTools.nip19.nsecEncode(results.privateKeyHex);
                    results.npubBech32 = window.nostrTools.nip19.npubEncode(results.publicKeyHex);
                }
                
            } catch (error) {
                results.error = error.message;
            }
            
            return results;
        }
        
        // Event Listener f√ºr die Eingabefelder
        document.getElementById('test-private-key').addEventListener('input', async function() {
            const inputValue = this.value.trim();
            const results = await handlePrivateKeyInput(inputValue);
            
            updateUI(results);
            updateDebugInfo(results);
        });
        
        function updateUI(results) {
            const publicKeyInput = document.getElementById('test-public-key');
            const privateFormats = document.getElementById('private-key-formats');
            const publicFormats = document.getElementById('public-key-formats');
            
            if (results.error) {
                publicKeyInput.value = '';
                privateFormats.textContent = `‚ùå Fehler: ${results.error}`;
                publicFormats.textContent = '';
                return;
            }
            
            if (!results.privateKeyHex) {
                publicKeyInput.value = '';
                privateFormats.textContent = '';
                publicFormats.textContent = '';
                return;
            }
            
            // Format-Pr√§ferenz (simuliert localStorage)
            const showBech32 = localStorage.getItem('test-show-bech32') === 'true';
            
            if (showBech32) {
                publicKeyInput.value = results.npubBech32;
                privateFormats.innerHTML = `<strong>HEX:</strong> ${results.privateKeyHex}<br><strong>bech32:</strong> ${results.nsecBech32}`;
                publicFormats.innerHTML = `<strong>HEX:</strong> ${results.publicKeyHex}<br><strong>bech32:</strong> ${results.npubBech32}`;
            } else {
                publicKeyInput.value = results.publicKeyHex;
                privateFormats.innerHTML = `<strong>HEX:</strong> ${results.privateKeyHex}<br><strong>bech32:</strong> ${results.nsecBech32}`;
                publicFormats.innerHTML = `<strong>HEX:</strong> ${results.publicKeyHex}<br><strong>bech32:</strong> ${results.npubBech32}`;
            }
        }
        
        function updateDebugInfo(results) {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML = `
                <strong>Input Format:</strong> ${results.inputFormat}<br>
                <strong>Private Key HEX:</strong> ${results.privateKeyHex || 'N/A'}<br>
                <strong>Public Key HEX:</strong> ${results.publicKeyHex || 'N/A'}<br>
                <strong>nsec bech32:</strong> ${results.nsecBech32 || 'N/A'}<br>
                <strong>npub bech32:</strong> ${results.npubBech32 || 'N/A'}<br>
                <strong>Error:</strong> ${results.error || 'None'}
            `;
        }
        
        function toggleFormat() {
            const current = localStorage.getItem('test-show-bech32') === 'true';
            localStorage.setItem('test-show-bech32', (!current).toString());
            
            // Re-trigger input to update display
            const input = document.getElementById('test-private-key');
            input.dispatchEvent(new Event('input'));
            
            const format = !current ? 'bech32' : 'HEX';
            addTestResult(`üîÑ Format umgeschaltet zu: ${format}`, 'info');
        }
        
        function clearFields() {
            document.getElementById('test-private-key').value = '';
            document.getElementById('test-public-key').value = '';
            document.getElementById('private-key-formats').textContent = '';
            document.getElementById('public-key-formats').textContent = '';
            document.getElementById('debug-info').textContent = '';
            addTestResult('üóëÔ∏è Felder geleert', 'info');
        }
        
        async function runTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="info test-result">üèÉ‚Äç‚ôÇÔ∏è Tests werden ausgef√ºhrt...</div>';
            
            const testCases = [
                {
                    name: 'HEX Private Key Test',
                    input: '0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef',
                    expectedFormat: 'hex'
                },
                {
                    name: 'bech32 nsec Test',
                    input: 'nsec1qyfe883hey6jrgj2xvk5g3dfmfqfzm842p4p92ust2sh9sez2fqgqrxmg5s',
                    expectedFormat: 'bech32'
                },
                {
                    name: 'Invalid HEX Test',
                    input: '12345', // zu kurz
                    expectedFormat: 'invalid'
                },
                {
                    name: 'Invalid bech32 Test',
                    input: 'nsec1invalid',
                    expectedFormat: 'invalid'
                }
            ];
            
            let passed = 0;
            let total = testCases.length;
            
            for (const testCase of testCases) {
                try {
                    const results = await handlePrivateKeyInput(testCase.input);
                    
                    let success = false;
                    if (testCase.expectedFormat === 'hex' || testCase.expectedFormat === 'bech32') {
                        success = results.inputFormat === testCase.expectedFormat && 
                                 results.privateKeyHex && 
                                 results.publicKeyHex && 
                                 !results.error;
                    } else if (testCase.expectedFormat === 'invalid') {
                        success = results.error !== null;
                    }
                    
                    if (success) {
                        passed++;
                        addTestResult(`‚úÖ ${testCase.name}: Bestanden`, 'success');
                    } else {
                        addTestResult(`‚ùå ${testCase.name}: Fehlgeschlagen - ${results.error || 'Unerwartetes Ergebnis'}`, 'error');
                    }
                    
                } catch (error) {
                    addTestResult(`‚ùå ${testCase.name}: Fehler - ${error.message}`, 'error');
                }
            }
            
            const summary = `üìä Testergebnisse: ${passed}/${total} Tests bestanden`;
            addTestResult(summary, passed === total ? 'success' : 'error');
        }
        
        function addTestResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }
        
        // Initialisierung
        document.addEventListener('DOMContentLoaded', async function() {
            await waitForNostrTools();
            addTestResult('üöÄ nostr-tools geladen und bereit f√ºr Tests', 'success');
            addTestResult('üí° Geben Sie einen privaten Schl√ºssel ein (HEX oder nsec) um die automatische Schl√ºsselgenerierung zu testen', 'info');
        });
    </script>
</body>
</html>
